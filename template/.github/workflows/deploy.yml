name: Deploy to VPS

on:
  push:
    branches: [ main ]

env:
  APP_NAME: ${{ github.event.repository.name }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Deploy to VPS
      env:
        VPS_HOST: ${{ secrets.VPS_HOST }}
        VPS_USER: ${{ secrets.VPS_USER }}
        VPS_SSH_KEY: ${{ secrets.VPS_SSH_KEY }}
        APP_DOMAIN: ${{ vars.APP_DOMAIN }}
        APP_PORT: ${{ vars.APP_PORT }}
      run: |
        # Setup SSH
        mkdir -p ~/.ssh
        echo "$VPS_SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
        
        # Create app directory on VPS
        ssh -i ~/.ssh/deploy_key $VPS_USER@$VPS_HOST "mkdir -p /apps/$APP_NAME"
        
        # Clear existing files (non-atomic deploy)
        ssh -i ~/.ssh/deploy_key $VPS_USER@$VPS_HOST "rm -rf /apps/$APP_NAME/*"
        
        # Copy files to VPS
        scp -i ~/.ssh/deploy_key -r ./* $VPS_USER@$VPS_HOST:/apps/$APP_NAME/
        
        # Create .env file with production secrets
        ssh -i ~/.ssh/deploy_key $VPS_USER@$VPS_HOST << 'ENDSSH'
        cd /apps/$APP_NAME
        
        # Write environment variables
        cat > .env << EOF
        NODE_ENV=production
        APP_NAME=${{ env.APP_NAME }}
        APP_DOMAIN=${{ vars.APP_DOMAIN }}
        APP_PORT=${{ vars.APP_PORT }}
        COMMIT_SHA=${{ github.sha }}
        
        # Add your app-specific secrets here
        # DATABASE_URL=${{ secrets.DATABASE_URL }}
        # API_KEY=${{ secrets.API_KEY }}
        EOF
        
        # Build and deploy
        docker compose build --pull --build-arg COMMIT_SHA=${{ github.sha }}
        docker compose up -d --force-recreate
        
        # Wait for health check
        echo "Waiting for service to be healthy..."
        for i in {1..30}; do
          if docker compose ps | grep -q "healthy"; then
            echo "Service is healthy!"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "Service failed to become healthy"
            docker compose logs
            exit 1
          fi
          sleep 2
        done
        
        # Cleanup old images
        docker image prune -f --filter "until=24h"
        ENDSSH
        
        # Cleanup SSH key
        rm ~/.ssh/deploy_key

    - name: Notify deployment status
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "âœ… Deployment successful!"
          echo "ðŸŒ Application available at: https://${{ vars.APP_DOMAIN }}"
        else
          echo "âŒ Deployment failed!"
        fi
